# Lec 1 ä»‹ç»æ•°æ®åº“ & å…³ç³»æ¨¡å‹ & SQL



## åŸºæœ¬æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯æ•°æ®åº“ï¼Ÿ

- ç»“æ„åŒ–æ•°æ®çš„é›†åˆ
  - ä¸€èˆ¬è¢«ç»„ç»‡æˆâ€œè®°å½•â€,  ä¸€èˆ¬åœ¨ç£ç›˜ä¸Šï¼Œæ•°æ®é‡éå¸¸å¤§
  - ä»¥åŠè®°å½•ä¹‹é—´çš„å…³ç³»

- è¿™é—¨è¯¾é‡Œé¢æåˆ°çš„æ•°æ®åº“æ˜¯æŒ‡ï¼š DBMSã€‚
  - ç”¨æ¥å­˜å‚¨å’ŒæŸ¥è¯¢æ•°æ®åº“çš„è½¯ä»¶ç³»ç»Ÿã€‚


### æ•°æ®åº“åˆ†ç±»

![æˆªå±2024-02-06 04.38.50](http://198.46.215.27:49153/i/66954d3007cb8.png)

**æ•°æ®æ¨¡å‹(data model) & å¸ƒå±€(layout)**

- åœ¨æ•°æ®åº“ä¸­æ„é€ å’Œè¡¨ç¤ºæ•°æ®çš„ç³»ç»Ÿæ–¹æ³•
- å¯¹æ•°æ®ä¸€è‡´æ€§ã€å…±äº«æ•°æ®ã€ä»¥åŠé«˜æ•ˆè®¿é—®æŒä¹…åŒ–æ•°æ®éå¸¸é‡è¦
- æ•°æ®æ¨¡å‹ä¸¾ä¾‹
  - å…³ç³»å‹ ï¼ˆå¤§éƒ¨åˆ†DBMSé‡‡ç”¨ï¼‰
  - éå…³ç³»å‹
    - K/V
    - æ–‡æ¡£/XML/å¯¹è±¡
    - Wide-Column/Column-Family

  - Array/Matrix/Vectors (æœºå™¨å­¦ä¹ )
  - è¿‡æ—¶
    - åˆ†å±‚
    - ç½‘ç»œ
    - å¤šå€¼


**Schema**

æ˜¯æŒ‡ç»™å®šä¸€ä¸ªæ•°æ®æ¨¡å‹ï¼Œå¯¹è¯¥æ•°æ®é›†åˆï¼ˆå®ä½“ï¼‰çš„ä¸€ç§æè¿°

**å£°æ˜å¼æŸ¥è¯¢**

- æ•°æ®åº“æŸ¥è¯¢è¿‡ç¨‹(query processing)
- è®¿é—®å’Œæ“çºµæ•°æ®çš„ç®—æ³•

**ä¸€è‡´æ€§/äº‹åŠ¡("ACID")**

**å…³ç³»æ¨¡å‹æœ¯è¯­ä¸æ—¥å¸¸ç”Ÿæ´»æœ¯è¯­å¯¹æ¯”**

![æˆªå±2024-02-21 11.52.43](http://198.46.215.27:49153/i/65d573948db93.png)

## æ¡ˆä¾‹ï¼šåŠ¨ç‰©å›­ç½‘ç«™

### ç‰¹æ€§

- ç®¡ç†å‘˜æ¥å£
  - ç¼–è¾‘
  - æ·»åŠ åŠ¨ç‰©
- å…¬å…±è®¾æ–½
  - å›¾ç‰‡ & åœ°å›¾
- åŠ¨ç‰©é¥²å…»å‘˜
  - å–‚å…»æ—¶é—´
- 1Kä¸ªåŠ¨ç‰©ï¼Œ5Kä¸ªURLï¼Œ 10ä¸ªç®¡ç†å‘˜ï¼Œ200ä¸ªåŠ¨ç‰©é¥²å…»å‘˜



### åŠ¨ç‰©å›­æ•°æ®æ¨¡å‹

#### å®ä½“å…³ç³»å›¾

![æˆªå±2024-02-06 04.49.39](http://198.46.215.27:49153/i/669573f45e804.png)

- åŠ¨ç‰©å®ä½“ï¼š 1åå­—ã€1å¹´é¾„ã€1å“ç§
- é¥²å…»å‘˜å®ä½“ï¼š 1åå­—
- ç¬¼å­å®ä½“ï¼š 1æ¸…ç†æ—¶é—´ã€1å»ºç­‘æ ‡å·
- ä¸€ä¸ªç¬¼å­å®ä½“**åŒ…å«**å¤šä¸ªåŠ¨ç‰©å®ä½“
- ä¸€ä¸ªåŠ¨ç‰©é¥²å…»å‘˜çœ‹ç®¡å¤šä¸ªç¬¼å­ï¼Œä¸€ä¸ªç¬¼å­è¢«å¤šä¸ªé¥²å…»å‘˜çœ‹ç®¡

> æœ‰å…¶ä»–æ¯”è¡¨é›†åˆæ›´å¥½çš„æ–¹å¼è¡¨ç¤ºåŠ¨ç‰©å›­æ•°æ®å—ï¼Ÿ
>
>  ä¸åŒçš„è¡¨ç¤ºæ–¹æ³•ä¹‹é—´çš„æƒè¡¡ç‚¹åœ¨å“ªé‡Œï¼Ÿ

#### åˆ†å±‚è¡¨ç¤ºæ³•

cage 1
	Tim
		giraffe
		13 yrs
	Sally
		student
		1 yr

cage 2
	Sam
		salamander
		3 yrs

#### å›¾è¡¨ç¤ºæ³•

```mermaid
graph TD
    A[animals] --> B[Tim]
    A[animals] --> C[Sally]
    A[animals] --> D[Sam]
    B[Tim] --> E[cage1]
    C[Sally] --> E[cage1]
    D[Sam] --> F[cage2]
    



```

####  æ‰å¹³è¡¨ç¤ºæ³•

| name  | age  | species    | cageno | feedtime | bldg |
| ----- | ---- | ---------- | ------ | -------- | ---- |
| Tim   | 13   | giraffe    | 1      | 1:30     | 1    |
| Sam   | 3    | salamander | 2      | 2:30     | 2    |
| Sally | 1    | student    | 1      | 1:30     | 1    |

> è¿™æ˜¯ä¸€ä¸ªå¥½çš„è¡¨ç¤ºæ–¹æ³•å—ï¼Ÿ ä¸ºä»€ä¹ˆï¼Ÿ

æ‰å¹³åŒ–è¡¨ç¤ºæ–¹æ³•æ²¡æœ‰â€è§„èŒƒåŒ–â€œï¼ˆnormalized)â€”â€”æ•°æ®é‡å¤äº†

### SQL

SQLï¼ŒStructured Query Languageï¼Œç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€

**æŸ¥è¯¢é•¿é¢ˆé¹¿çš„åç§°**

- å‘½ä»¤å¼

  ```python
  for each row r in animals:
    if r.species = 'giraffe':
      print(r.name)
  ```

- å£°æ˜å¼

  ```sql
  SELECT r.name FROM animals WHERE r.species = 'giraffe';
  ```



**æŸ¥è¯¢32å·å»ºç­‘çš„ç¬¼å­**

- å‘½ä»¤å¼

  ```python
  for each row a in animals:
    for each row c in cages:
      if a.cageno == c.no and c.bldg = 32:
      	print(a)
  ```

- å£°æ˜å¼

  ```sql
  SELECT a.name FROM animals AS a, cages AS c WHERE a.cageno = c.no AND c.bldg = 32
  ```

å¯ä»¥çœ‹å‡ºå‘½ä»¤å¼ç”¨äº†åµŒå¥—å¾ªç¯ï¼Œè€Œå£°æ˜å¼æ˜¯ç”¨è¿æ¥çš„æ–¹å¼ã€‚



**å¤æ‚çš„æŸ¥è¯¢**

![æˆªå±2024-07-16 03.35.51](http://198.46.215.27:49153/i/66957a1e2b6de.png)

ä»ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œå£°æ˜å¼æŸ¥è¯¢**å…³æ³¨åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æ€ä¹ˆåš**

- å¯¹äºç»™å®šçš„ SQLï¼Œæœ‰å¾ˆå¤šå¯èƒ½çš„ç¨‹åºè®¡åˆ’
- é™¤äº†éå†æ‰€æœ‰è®°å½•ï¼Œæˆ‘ä»¬è¿˜èƒ½åšäº›ä»€ä¹ˆï¼Ÿ
  - æŒ‰ç…§åŠ¨ç‰©ç±»å‹è¿›è¡Œæ’åº
    - è¿™ç§æ’åºæ–¹æ³•å¯¹äºç‰¹å®šç±»å‹ï¼ˆä¾‹å¦‚ "bears"ï¼‰çš„æŸ¥è¯¢éå¸¸æœ‰æ•ˆï¼Œå¯ä»¥å¿«é€Ÿå®šä½ç›®æ ‡æ•°æ®
    - å³æ’å…¥æ“ä½œä¼šå˜æ…¢ï¼Œå› ä¸ºæ¯æ¬¡æ’å…¥æ–°è®°å½•æ—¶éƒ½éœ€è¦ä¿æŒæ’åºé¡ºåº
  - å°†åŠ¨ç‰©è¡¨å­˜å‚¨åˆ°å“ˆå¸Œè¡¨ä¸­ï¼Œæˆ–è€…æ ‘ç»“æ„(â€œç´¢å¼•â€ï¼‰

#### SQLæ‰§è¡Œè¿‡ç¨‹



```mermaid
graph TD;
    SQL["SQL"] --> ProceduralPlan["Procedural Planç¨‹åºè®¡åˆ’"];
    ProceduralPlan --> OptimizedPlan["Optimized Planä¼˜åŒ–è®¡åˆ’"];
    OptimizedPlan --> CompiledProgram["Compiled Programç¼–è¯‘ç¨‹åº"];
```

é€»è¾‘ç‹¬ç«‹

- å¦‚æœæˆ‘ä»¬æƒ³è¦æ›´æ”¹schemè€Œä¸æ›´æ”¹ä»£ç å‘¢ï¼Ÿ
- å¦‚æœæˆ‘ä»¬åªæ˜¯æ·»åŠ ä¸€åˆ—æˆ–è€…ä¸€ä¸ªè¡¨
- è§†å›¾å…è®¸æˆ‘ä»¬å°†ä¸€ä¸ªæ—§çš„schemaæ˜ å°„åˆ°æ–°çš„

è§†å›¾

- è§†å›¾æ˜¯ä¸€ä¸ªå°†ä¸€ä¸ªè¡¨è¡¨ç¤ºå…¶ä»–è¡¨çš„é€»è¾‘å®šä¹‰
- ä¾‹å­: ä¸€ä¸ªè®¡ç®—æ¯ä¸ªç¬¼å­çš„åŠ¨ç‰©è§†å›¾

```sql
CREATE VIEW cage_count as (SELECT cageno, count(*) FROM animal JOIN cages ON cageno=no GROUP by cageno)
```

- ä¾‹å­ï¼š å¦‚æœæˆ‘æƒ³æ·»åŠ å¤šä¸ªå–‚å…»æ—¶é—´ã€‚
  - Rename existing animals table to animals2
  - Create feedtimes table
  - Copy feedtime data from animals
  - Remove feedtime column from animals
  - Create a view called animals that is a query over animals and feedtimes

```sql
CREATE VIEW animals as(
SELECT name, age, species,cageno,
	(SELECT feedtime FROM feedtimes WHERE animalid = id LIMIT 1) FROM animals
)
```

## æ•°æ®æ¨¡å‹å‘å±•å†å²

### ä¸åŒçš„æ•°æ®æ¨¡å‹

- åˆ†å±‚æ•°æ®æ¨¡å‹ï¼ˆIMS/DL1)ï¼Œ 20ä¸–çºª60å¹´ä»£
- ç½‘ç»œæ•°æ®æ¨¡å‹ï¼ˆCODASYL)ï¼Œ 20ä¸–çºª70å¹´ä»£
- å…³ç³»æ•°æ®æ¨¡å‹ï¼Œ 20ä¸–çºª70å¹´ä»£

### ä¸»è¦è§‚ç‚¹

- æ•°æ®å†—ä½™ï¼ˆå¦‚ä½•é¿å…ï¼‰
- ç‰©ç†å’Œé€»è¾‘æ•°æ®ç‹¬ç«‹
- å…³ç³»ä»£æ•°å’Œå…¬ç†

**æ¡ˆä¾‹ï¼š åŠ¨ç‰©å›­ç½‘ç«™**

![æˆªå±2024-07-16 04.04.25](http://198.46.215.27:49153/i/669580cf1abef.png)

schemaï¼š å±æ€§åç§°å’Œå±æ€§ç±»å‹

è¡Œï¼Œä¹Ÿç§°è®°å½•ï¼Œæˆ–è€…å…ƒç¥–

----

å¯¹åŠ¨ç‰©æ•°æ®æ¨¡å‹è¿›è¡Œå°æ›´æ”¹

- æ¯ä¸ªåŠ¨ç‰©éƒ½åœ¨ä¸€ä¸ªç¬¼å­é‡Œï¼Œå¤šä¸ªåŠ¨ç‰©å¯èƒ½å…±äº«ä¸€ä¸ªç¬¼å­
- æ¯ä¸ªåŠ¨ç‰©è¢«1ä¸ªé¥²å…»å‘˜ç…§é¡¾ï¼Œé¥²å…»å‘˜éœ€è¦ç…§çœ‹å¤šä¸ªåŠ¨ç‰©

### IMSï¼ˆåˆ†å±‚æ¨¡å‹ï¼‰

- æ•°æ®è¢«ç»„ç»‡ç§°æ®µsegment

  - æ®µæ˜¯è®°å½•çš„é›†åˆï¼Œæ¯ä¸ªæ®µéƒ½æœ‰ç›¸åŒçš„æ®µç±»å‹ã€‚æ®µç±»å‹å®šä¹‰äº†è®°å½•çš„ç»“æ„

  - IMS ä¸­çš„æ•°æ®æŒ‰æ®µç±»å‹æ’åˆ—æˆæ ‘çŠ¶ç»“æ„ï¼Œä¾‹å¦‚

    ```
    Keepers
    	Animals
    		Cages
    
    or
    
    Keepers
    	Cages
    		Animals
    ```

- æ®µæœ‰ä¸åŒçš„ç‰©ç†è¡¨ç¤ºæ–¹å¼ï¼Œå†³å®šäº†å®ƒä»¬åœ¨å­˜å‚¨å’Œè®¿é—®ä¸Šçš„ç»„ç»‡æ–¹å¼ï¼Œæ¯”å¦‚

  - æ— åº
  - å¯é€šè¿‡ç´¢å¼•è¿›è¡Œç»„ç»‡
    - æŒ‰æŸä¸ªå…³é”®å­—æ’åº
    - é€šè¿‡å“ˆå¸Œå‡½æ•°ç»„ç»‡

**åˆ†å±‚è¡¨ç¤ºçš„ä¾‹å­**

å‡å¦‚æœ‰ä¸¤ä¸ªé¥²å…»å‘˜ï¼Œ3ä¸ªåŠ¨ç‰©ï¼Œ2ä¸ªç¬¼å­

![æˆªå±2024-07-16 09.38.31](http://198.46.215.27:49153/i/6695cf1c64dea.png)

è¿™ä¸ªä¾‹å­ä¸­çš„ç‰©ç†è¡¨ç¤ºæ–¹æ³•ä¸º

```
Keeper1æ®µ
A1æ®µ   A2æ®µ  A3æ®µ   // Aè¡¨animal
C1æ®µ   C2æ®µ  C3æ®µ   // Cè¡¨cage
```



#### æ®µçš„ç»“æ„

- æ¯ä¸ªæ®µéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç‰©ç†è¡¨ç¤ºæ–¹å¼
  - ç”±æ•°æ®åº“ç®¡ç†å‘˜é€‰æ‹©
- æ®µçš„ç»“æ„é€‰æ‹©å½±å“åˆ°ä»–ä»¬æ‰€æ”¯æŒçš„æ“ä½œã€‚

#### IMSã€DL/1 çš„æ“ä½œ

- GetUnique(segtype, pred)

  - ä»æŒ‡å®šæ®µç±»å‹ä¸­è·å–æ»¡è¶³ç‰¹å®šæ¡ä»¶ï¼ˆpredï¼‰çš„ç¬¬ä¸€ä¸ªè®°å½•
  - åªæœ‰è¢«ç»„ç»‡æˆhash/æœ‰åºæ®µæ‰èƒ½è¢«æ”¯æŒ

- GetNext(segtype, pred)

  - è·å–å±‚æ¬¡ç»“æ„ä¸­ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€ä¸ªæˆ–ä¸‹ä¸€ä¸ªè®°å½•

  - ç¬¬ä¸€æ¬¡è°ƒç”¨ `GetNext("Animals", "type = 'salamander'")`ï¼šåœ¨ `Animals` æ®µä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç±»å‹ä¸º "salamander" çš„è®°å½•ã€‚

    åç»­è°ƒç”¨ `GetNext("Animals", "type = 'salamander'")`ï¼šè·å–ä¸‹ä¸€ä¸ªç±»å‹ä¸º "salamander" çš„è®°å½•ã€‚

- GetNextParent(segtype, pred)

  - ç±»ä¼¼ `GetNext`ï¼Œä½†ä¸ä¼šå‘ä¸Šç§»åŠ¨åˆ°å±‚æ¬¡ç»“æ„ä¸­çš„ä¸‹ä¸€ä¸ªçˆ¶æ®µ
  - é™åˆ¶åœ¨å½“å‰çˆ¶æ®µå†…æœç´¢ã€‚

- Deleteï¼Œ Insert

**ä¾‹å­**



![æˆªå±2024-07-16 09.54.38](http://198.46.215.27:49153/i/6695d2e329fca.png)

**1ã€ æ‰¾åˆ°é¥²å…»å‘˜Janeçœ‹ç®¡çš„æ‰€æœ‰ç¬¼å­**

```
GetUnique(Keepers, name="Jane") // å°†å½“å‰ä½ç½®éšå¼åœ°å¯¼èˆªåˆ° Jane çš„è®°å½•ã€‚æ­¤æ—¶ï¼Œç³»ç»Ÿåœ¨ Keepers æ®µå†…ï¼ŒæŒ‡å‘ Jane çš„è®°å½•

Until done:
  cageid = GetNextParent(cages).no  // æ“ä½œè·å–ä¸‹ä¸€ä¸ªç¬¼å­çš„è®°å½•
  print cageid
```

`GetNextParent` æ“ä½œä¼šåœ¨å½“å‰çˆ¶è®°å½•ï¼ˆå³ Janeï¼‰çš„èŒƒå›´å†…æŸ¥æ‰¾ `cages` æ®µçš„è®°å½•ï¼Œå¹¶è·å–è¯¥è®°å½•çš„ ID

**2ã€æ‰¾åˆ°çœ‹ç®¡6å·ç¬¼å­çš„ç®¡ç†å‘˜**

```
keep = GetUnique(keepers)
Until done:
  cage = GetNextParent(cages, id=6)
  if (cage is not null):
  	print keep
 	keep = GetNext(keepers)
```

#### ç¼ºç‚¹

- æ•°æ®é‡å¤ï¼Œå› ä¸ºæ¯ä¸ªå±‚æ¬¡çš„èŠ‚ç‚¹éƒ½å¿…é¡»åŒ…å«ç›¸å…³çš„å­èŠ‚ç‚¹ä¿¡æ¯ã€‚
  - åœ¨å±‚æ¬¡æ•°æ®åº“ä¸­ï¼Œå®Œå…¨é¿å…æ•°æ®å†—ä½™æ˜¯å¾ˆå›°éš¾çš„ï¼Œå› ä¸ºå±‚æ¬¡ç»“æ„æœ¬èº«ä¼šå¯¼è‡´æŸäº›æ•°æ®é¡¹çš„é‡å¤å‡ºç°ã€‚ä¸åŒçš„å±‚æ¬¡ç»“æ„è®¾è®¡å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘å†—ä½™ï¼Œä½†æ€»ä¼šæœ‰æŸäº›éƒ¨åˆ†çš„æ•°æ®ä¼šé‡å¤å­˜å‚¨ã€‚
- ä½çº§ç¼–ç¨‹æ¥å£çš„ç—›ç‚¹ï¼Œéœ€è¦ç¼–å†™è¯¦ç»†çš„æœç´¢ç®—æ³•æ¥éå†å±‚æ¬¡ç»“æ„ä¸­çš„æ•°æ®
- ç‰©ç†æ•°æ®ç‹¬ç«‹æ€§çš„é™åˆ¶
  - å¦‚æœæ ¹æ®µçš„å­˜å‚¨æ–¹å¼ä»ç´¢å¼•æ”¹å˜ä¸ºå“ˆå¸Œï¼Œé‚£ä¹ˆé‚£äº›ä½¿ç”¨ `GetNext` æ“ä½œçš„ç¨‹åºå¯èƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºå“ˆå¸Œæ®µä¸æ”¯æŒ `GetNext` æ“ä½œ
  - æ ¹æ®µçš„ç±»å‹æ”¹å˜ï¼Œä¹Ÿä¼šå¦‚æ­¤
  - å¦‚æœæ ¹æ®µæ˜¯é¡ºåºå­˜å‚¨çš„ï¼Œé‚£ä¹ˆæ— æ³•åœ¨ä¸­é—´æ’å…¥æ–°çš„è®°å½•
- é€»è¾‘æ•°æ®ç‹¬ç«‹æ€§çš„é™åˆ¶
  - å¦‚æœschemaæ”¹å˜äº†ï¼Œç¨‹åºä¹Ÿè¦è·Ÿç€æ”¹

#### é€»è¾‘æ•°æ®ç‹¬ç«‹æ€§

å‡è®¾åŠ¨ç‰©å›­ç®¡ç†å±‚å†³å®šæ”¹å˜é¥²å…»å‘˜çš„å·¥ä½œæ–¹å¼ï¼š

- **æ—§åˆ¶åº¦**ï¼šä¸€ä¸ªé¥²å…»å‘˜è´Ÿè´£å¤šä¸ªç¬¼å­å’Œç¬¼å­ä¸­çš„æ‰€æœ‰åŠ¨ç‰©ã€‚
- **æ–°åˆ¶åº¦**ï¼šä¸€ä¸ªé¥²å…»å‘˜åªè´Ÿè´£ä¸€ä¸ªç¬¼å­åŠè¯¥ç¬¼å­ä¸­çš„æ‰€æœ‰åŠ¨ç‰©

è¿™æ ·ä¸€æ¥ï¼Œä½¿ç”¨ `GN` æˆ– `GNP` æ“ä½œè®¿é—®æ•°æ®çš„ç¨‹åºå¿…é¡»æ›´æ–°ï¼Œå¦åˆ™ç¨‹åºçš„è¡Œä¸ºå¯èƒ½ä¸å†ç¬¦åˆé¢„æœŸ

```
// æ—§ç»“æ„
Keepers
  cages
  	Animal
// æ–°ç»“æ„
cages
  keepers
    Animal  
```

### CODASYL æ•°æ®æ¨¡å‹

ç”¨æ¥è§£å†³IMS/PL1çš„å±€é™æ€§ï¼ŒåŸºäºå›¾æˆ–ç½‘ç»œæ•°æ®æ¨¡å‹

![æˆªå±2024-07-16 10.20.57](http://198.46.215.27:49153/i/6695d91249142.png)

è®°å½•èƒ½å¤Ÿæ ¹æ®ä¸€äº›keyè¢«hashæˆ–è€…æ’åºã€‚

**æ‰¾åˆ°Joeçœ‹ç®¡çš„æ‰€æœ‰ç¬¼å­**

![æˆªå±2024-07-16 10.24.31](http://198.46.215.27:49153/i/6695d9e7981ef.png)

```
Find keepers(name = 'Joe')
	Until done:
		Find next animal in caredforby
			Find cage in livesin
```

è¿™ç§ç¼–ç¨‹æ–¹æ³•å°±åƒæ˜¯åœ¨ä¸€ä¸ªå¤æ‚çš„åœ°å›¾ä¸Šæ‰¾åˆ°ä¸€ä¸ªèµ·ç‚¹ï¼Œç„¶åæ²¿ç€è·¯å¾„è¿›è¡Œå¯¼èˆª

- æ¯ä¸€è¡Œä»£ç éƒ½éšå«åœ¨è¿™ä¸ªç»“æ„ä¸­çš„æŸä¸ªä½ç½®
- éœ€è¦è®°ä½ä½ æ‰€åœ¨çš„ä½ç½®

#### ç¼ºç‚¹

- éå¸¸å¤æ‚â€”â€”å¯¼èˆªå¼ç¼–ç¨‹
- ç¨‹åºç¼ºä¹ç‰©ç†æˆ–é€»è¾‘æ•°æ®ç‹¬ç«‹æ€§:
  - å¦‚æœè¦ä¿®æ”¹æ•°æ®åº“ç»“æ„ï¼Œå°±å¾—æ”¹ç¨‹åºï¼›
  - ä¹Ÿä¸èƒ½éšä¾¿æ”¹ç‰©ç†è¡¨ç¤ºï¼Œå› ä¸ºä¸åŒçš„ç´¢å¼•ç±»å‹æ”¯æŒçš„æ“ä½œå¯èƒ½ä¸ä¸€æ ·ã€‚

**å…³ç³»æ¨¡å‹**å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚

### å…³ç³»å‹æ•°æ®æ¨¡å‹

#### åŸåˆ™

- ç®€å•çš„è¡¨ç¤ºæ–¹å¼

- é¢å‘é›†åˆçš„ç¼–ç¨‹æ¨¡å‹ï¼Œä¸éœ€è¦"å¯¼èˆª"

- ä¸éœ€è¦ç‰©ç†æ•°æ®æ¨¡å‹çš„æè¿°(!)
  - ä¾‹å¦‚ï¼Œä¸éœ€è¦æŒ‡å®šæ’åºé¡ºåºã€å“ˆå¸Œç­‰

#### åŸºæœ¬ç‰¹å¾

- **æ•°æ®è¡¨ç¤ºæ–¹å¼**ï¼šæ‰€æœ‰æ•°æ®éƒ½ä»¥è®°å½•ï¼ˆå…ƒç»„ï¼‰çš„å½¢å¼å­˜åœ¨äºè¡¨æ ¼ä¸­ã€‚
- **è¡¨æ ¼å±æ€§**ï¼šè¡¨æ ¼æ˜¯æ— åºçš„é›†åˆï¼Œå…¶ä¸­ä¸åŒ…å«é‡å¤çš„è®°å½•ã€‚
- **æ•°æ®åº“ç»“æ„**ï¼šæ•°æ®åº“ç”±ä¸€ä¸ªæˆ–å¤šä¸ªè¿™æ ·çš„è¡¨æ ¼ç»„æˆã€‚
- **æ¨¡å¼æè¿°**ï¼šæ¯ä¸ªè¡¨æ ¼ï¼ˆå…³ç³»ï¼‰éƒ½æœ‰ä¸€ä¸ªæ¨¡å¼ï¼Œæè¿°äº†è¡¨æ ¼ä¸­æ¯ä¸ªåˆ—æˆ–å­—æ®µçš„ç±»å‹ã€‚
- **å­—æ®µç±»å‹**ï¼šæ¯ä¸ªå­—æ®µéƒ½æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯é›†åˆæˆ–å…¶ä»–å…³ç³»ã€‚
- **ç‰©ç†è¡¨ç¤ºä¸æŒ‡å®š**ï¼šå…³ç³»æ¨¡å‹ä¸å…³æ³¨æ•°æ®çš„ç‰©ç†å­˜å‚¨æ–¹å¼ï¼Œä¾‹å¦‚ç´¢å¼•ç±»å‹ã€åµŒå¥—ç»“æ„ç­‰ã€‚

**ä¾‹å­è¯´æ˜**

![æˆªå±2024-07-16 10.33.50](http://198.46.215.27:49153/i/6695dc1551b07.png)



## å…³ç³»ä»£æ•°

5ä¸ªåŸºæœ¬æ“ä½œ

- æŠ•å½±Projection (Ï€(T, c1, ... cn))
  - é€‰æ‹©éƒ¨åˆ†åˆ—ç»„æˆçš„å­é›†
- é€‰æ‹©Selection(ğ‚(T, pred))
  - é€‰æ‹©æ»¡è¶³æ¡ä»¶çš„è¡Œç»„æˆçš„å­é›†
- ç¬›å¡å°”ç§¯(å‰ç§¯ï¼ŒCross Product) (T1 x T2)
  - è¿æ¥ä¸¤ä¸ªè¡¨
- è”æ¥(â¨(T1, T2, pred)) = ğ‚(T1 x T2, pred)
  - ç”¨ä¸€ä¸ªåˆ¤å®šæ¡ä»¶è”æ¥ä¸¤ä¸ªè¡¨
- é›†åˆçš„æ“ä½œï¼ˆå¹¶ã€å·®ç­‰ï¼‰
- â€ä»£æ•°â€œâ€”â€”å¯¹å…¶è‡ªèº«çš„æ“ä½œå…·æœ‰å°é—­æ€§ã€‚ å¤§ç™½è¯å°±æ˜¯è¯´ï¼Œ æ— è®ºå¯¹æ•°æ®åº“ä¸­çš„å“ªä¸ªå…³ç³»ï¼ˆè¡¨ï¼‰è¿›è¡Œä»€ä¹ˆæ ·çš„æ“ä½œï¼Œéƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„å…³ç³»ï¼ˆè¡¨ï¼‰

![æˆªå±2024-02-21 16.23.14](http://198.46.215.27:49153/i/65d5b2fd62c4e.png)

**ç”¨ç¬›å¡å°”ç§¯å®ç°è¿æ¥**

![æˆªå±2024-07-16 10.45.49](http://198.46.215.27:49153/i/6695dee3754fb.png)

**ä¾‹å­ï¼š æ‰¾åˆ°ç¬¼å­å·32çš„åŠ¨ç‰©ä»¬**

```
ğ‚(
	â¨ (
		animals,
		cages,
		animals.cageno = cages.no
	),
	bldg = 32
)
```

> ä½ è§‰å¾—æ•°æ®åº“å°±æ˜¯è¿™æ ·å®ç°ä»£ç ï¼Ÿ

```
â¨(
	animals,
	ğ‚ (
		cages,
		bldg = 32
	),
	animals.cageno = cages.no
)
```



### å…³ç³»ä»£æ•°çš„ç­‰ä»·è§„åˆ™

- è¿æ¥é‡æ’åº(ç›®çš„å¾—åˆ°çš„Joinè®°å½•æœ€å°‘ï¼Œä¸€èˆ¬æœ‰è´ªå¿ƒç®—æ³•å’ŒåŠ¨æ€è§„åˆ’ç®—æ³•)
  - A â¨ B = B â¨ A
  - (A â¨ B) join C = A â¨ (B â¨ C)
- é€‰æ‹©é‡æ’åº
  - ğ‚1(ğ‚2(A)) = ğ‚2(ğ‚1(A))
- é€‰æ‹©ä¸‹æ¨
  - ğ‚(A â¨_pred B) = ğ‚(A) â¨\_pred ğ‚(B)
  - ğ‚å¯èƒ½ä»…ç”¨äºä¸€ä¸ªè¡¨
- æŠ•å½±ä¸‹æ¨
  - Ï€(ğ‚(A)) = ğ‚(Ï€(A))
  - å¯ä»¥åœ¨åº”ç”¨æŠ•å½±æ“ä½œä¹‹å‰æˆ–ä¹‹ååº”ç”¨ç­›é€‰æ“ä½œï¼Œç»“æœåº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚å‰ææ˜¯æŠ•å½±æ“ä½œä¸ä¼šç§»é™¤ç­›é€‰æ¡ä»¶ä¸­ä½¿ç”¨çš„å­—æ®µ
  - åŒæ ·èƒ½åº”ç”¨åœ¨è¿æ¥

## ç‰©ç†ç‹¬ç«‹æ€§

ç‰©ç†ç‹¬ç«‹æ€§æ˜¯æŒ‡å¯ä»¥æ›´æ”¹æ•°æ®çš„è¡¨ç¤ºæ–¹å¼è€Œæ— éœ€ä¿®æ”¹ä»£ç çš„èƒ½åŠ›ã€‚

ä¾‹å­

```sql
SELECT a.name FROM animals AS a, cages AS c
WHERE a.cageno = c.no AND c.bldg = 32
```

åœ¨ä¸Šè¿°æŸ¥è¯¢ä¸­ï¼Œå¹¶æ²¡æœ‰æ˜ç¡®æŒ‡å®šåŠ¨ç‰©å’Œç¬¼å­è¡¨æ ¼çš„æ•°æ®è¡¨ç¤ºæ–¹å¼ã€‚å®ƒä»¬å¯ä»¥æ˜¯æ’åºçš„ã€å­˜å‚¨åœ¨å“ˆå¸Œè¡¨æˆ–æ ‘ä¸­ç­‰ã€‚å¦‚æœæ”¹å˜äº†æ•°æ®çš„ç‰©ç†è¡¨ç¤ºæ–¹å¼ï¼ŒSQL æŸ¥è¯¢æœ¬èº«ä¸ä¼šæ”¹å˜ã€‚





## é€»è¾‘ç‹¬ç«‹æ€§

é€»è¾‘æ•°æ®ç‹¬ç«‹æ€§æ˜¯æŒ‡å¯ä»¥åœ¨ä¸éœ€è¦ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹æ›´æ”¹æ•°æ®åº“schemaã€‚

- å¦‚æœåªæ˜¯æ·»åŠ ä¸€ä¸ªåˆ—æˆ–è€…è¡¨æ ¼ï¼Œè¿™å¹¶ä¸ä¼šé€ æˆé—®é¢˜ã€‚
- è§†å›¾ï¼ˆViewsï¼‰å…è®¸æˆ‘ä»¬å°†æ—§çš„æ¨¡å¼æ˜ å°„åˆ°æ–°çš„æ¨¡å¼ï¼Œä½¿å¾—æ—§çš„ç¨‹åºä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚
- å³ä½¿æ˜¯åœ¨ä¿®æ”¹ç°æœ‰å­—æ®µçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡è‰¯å¥½çš„è§†å›¾è®¾è®¡ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿æ—§ç¨‹åºä¸æ–°æ¨¡å¼çš„å…¼å®¹æ€§ã€‚

### è§†å›¾(View)ç®€ä»‹

**è§†å›¾**æ˜¯ä¸€ä¸ªåŸºäºå…¶ä»–è¡¨çš„é€»è¾‘å®šä¹‰è¡¨çš„æ–¹å¼ã€‚

ä¾‹å¦‚ï¼Œ ä¸€ä¸ªè§†å›¾å¯ä»¥è®¡ç®—æ¯ä¸ªç¬¼å­ä¸­çš„åŠ¨ç‰©æ•°é‡

```sql
CREATE VIEW cage_count AS
(SELECT cageno, count(*)
FROM animals JOIN cages ON animals.cageno = cages.no
GROUP BY cageno
)
```

è¿™ä¸ªè§†å›¾å¯ä»¥åƒå…¶ä»–è¡¨ä¸€æ ·åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ã€‚

**è§†å›¾çš„ä¾‹å­**

>å‡è®¾æˆ‘æƒ³è¦æ·»åŠ å¤šä¸ªå–‚é£Ÿæ—¶é—´ï¼Ÿ
>
>å¦‚ä½•æ”¯æŒæ—§ç¨‹åºï¼Ÿ

- å°†ç°æœ‰çš„ `animals` è¡¨é‡å‘½åä¸º `animals2`ã€‚
- åˆ›å»ºä¸€ä¸ª `feedtimes` è¡¨æ ¼ã€‚
- ä» `animals2` ä¸­å¤åˆ¶å–‚é£Ÿæ—¶é—´æ•°æ®ã€‚
- ä» `animals2` ä¸­ç§»é™¤ `feedtime` åˆ—ã€‚
- åˆ›å»ºä¸€ä¸ªåä¸º `animals` çš„è§†å›¾ï¼Œè¯¥è§†å›¾æ˜¯å¯¹ `animals2` å’Œ `feedtimes` è¡¨çš„æŸ¥è¯¢

```sql
-- åˆ›å»ºä¸€ä¸ªåä¸º animals çš„è§†å›¾ï¼ŒæŸ¥è¯¢ animals2 å’Œ feedtimes è¡¨
CREATE VIEW animals AS
SELECT a.name, a.age, a.species, a.cageno,
       (SELECT feedtime FROM feedtimes WHERE animalid = a.id LIMIT 1) AS feedtime
FROM animals2 a
);
```

## æ€»ç»“ï¼š IMS vs. CODASYL vs. å…³ç³»å‹

![æˆªå±2024-07-16 11.04.29](http://198.46.215.27:49153/i/6695e3445f009.png)

## SQL

### Joinï¼ˆè”æ¥ï¼‰

#### å¼•å…¥

![æˆªå±2024-07-16 11.36.49](http://198.46.215.27:49153/i/6695ead864fcb.png)

åŠ å…¥é¥²å…»å‘˜å’Œç¬¼å­çš„å…³ç³»å¦‚ä¸Šæ‰€ç¤º

Schema:

- Animals: (aid, name, age, species, acageno)
- Cages(no, feedtime, bldg)
- Keepers(id, name)
- keeps(kid, cageno)



**æ‰¾åˆ°32å·å»ºç­‘ç‰©ä¸­çš„æ‰€æœ‰ç¬¼å­**

- å‘½ä»¤å¼

  ```
  for each row a in animals:
  	for each row c in cages:
  		if a.acageno = c.no and c.bldg = 32
  			output a
  ```

- å£°æ˜å¼

  ```sql
  SELECT name
  FROM animals, cages
  WHERE acageno = no AND bldg = 32;
  ```

- å¦å¤–ä¸€ç§å£°æ˜å¼è¯­æ³•

  ```sql
  SELECT name
  FROM animals JOIN cages on acageno = no
  WHERE bldg = 32;
  ```

  

### åˆ«åä¸æ­§ä¹‰

![æˆªå±2024-02-18 21.30.26](http://198.46.215.27:49153/i/6695f062a140d.png)

**ä¾‹å­ï¼š å–‚å…»ç†Šçš„æ‰€æœ‰é¥²å…»å‘˜**

```sql
SELECT name FROM keepers JOIN keeps ON id = kid
JOIN cages on cageno = no
JOIN animals on cageno = no
Where species = 'bear'
```

> è¿™ä¸ªsqlè¯­å¥å¹¶ä¸èƒ½ä½¿ç”¨ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

å› ä¸º SELECT name æ—¶å€™è¿™ä¸ªnameçš„æŒ‡ä»£ä¸æ˜ç¡®ï¼Œæ²¡æœ‰æŒ‡æ˜æ˜¯å“ªä¸ªå®ä½“ã€‚æ”¹æˆanimals.nameå³å¯

### èšåˆ

**ä¾‹å­ï¼š æ‰¾åˆ°æ¯ä¸ªç¬¼å­ç”±å¤šå°‘ä¸ªé¥²å…»å‘˜ç®¡ç†**

```sql
SELECT no, count(*)
FROM cages JOIN keeps ON on=cageno
GROUP BY no
```

> é‚£æ²¡æœ‰é¥²å…»å‘˜ç®¡ç†çš„ç¬¼å­å‘¢ï¼Ÿ

å¯ä»¥ä½¿ç”¨å³è”æˆ–è€…å¤–è”

> [!IMPORTANT]
>
> count(*)ï¼Œ æ‰€æœ‰è¡Œéƒ½è¢«ç»Ÿè®¡ï¼ˆåŒ…æ‹¬NULLï¼‰
>
> count(col) ï¼Œåªç»Ÿè®¡éç©ºçš„å€¼çš„è¡Œ

### Joinï¼ˆè”æ¥ï¼‰

#### å·¦è”

```sql
T1 LEFT JOIN T2 ON pred
```

- æ‰€æœ‰æ»¡è¶³ `pred` æ¡ä»¶çš„ `T1 x T2` è¡Œã€‚

- ä»¥åŠ `T1` ä¸­æ²¡æœ‰ä¸ `T2` ä¸­ä»»ä½•è¡ŒåŒ¹é…çš„æ‰€æœ‰è¡Œï¼ˆè¿™äº›è¡Œçš„ `T2` åˆ—å€¼å°†ä¸ºç©ºï¼‰ã€‚

#### å³è”

ä¸å·¦è”ç±»ä¼¼ï¼Œä½†æ˜¯æ–¹å‘ç›¸å

```sql
T1 LEFT JOIN T2 ON pred
```

- æ‰€æœ‰æ»¡è¶³ `pred` æ¡ä»¶çš„ `T1 x T2` è¡Œã€‚

- ä»¥åŠ `T2` ä¸­æ²¡æœ‰ä¸ `T1` ä¸­ä»»ä½•è¡ŒåŒ¹é…çš„æ‰€æœ‰è¡Œï¼ˆè¿™äº›è¡Œçš„ `T1` åˆ—å€¼å°†ä¸ºç©ºï¼‰ã€‚

#### å¤–è”/å…¨è”

å³æŠŠå·¦è”ç»“æœè¡¨+å³è”ç»“æœè¡¨ç»„åˆåœ¨ä¸€èµ·ï¼Œç„¶åè¿‡æ»¤æ‰é‡å¤çš„

```sql
T1 OUTER JOIN T2 ON pred
```

#### å†…è”ï¼ˆé»˜è®¤ï¼‰

```sql
T1 INNER JOIN T2 ON pred
# æˆ–è€…ç›´æ¥
T1 JOIN T2 ON pred
```

- æ‰€æœ‰æ»¡è¶³ `pred` æ¡ä»¶çš„ `T1 x T2` è¡Œ
- å¦‚æœæŸè¡Œåœ¨å…¶ä¸­ä¸€ä¸ªè¡¨ä¸­æ²¡æœ‰åŒ¹é…çš„è¡Œï¼Œé‚£ä¹ˆè¿™è¡Œå°†ä¸ä¼šå‡ºç°åœ¨ç»“æœé›†ä¸­

#### è‡ªè”

**ä¾‹å­ï¼ŒæŸ¥æ‰¾ç…§é¡¾ç†Šå’Œé•¿é¢ˆé¹¿çš„æ‰€æœ‰ç®¡ç†å‘˜**

```sql
SELECT keepers.name
FROM keepers JOIN keeps ON id = kid
JOIN cages ON cageno = no
JOIN animals ON acageno =cageno
WHERE species = 'Bear' AND = species = 'Giraffe'
```

> è¿™ä¸ªSQLå¹¶æ²¡æœ‰æ•ˆæœï¼Œä¸ºä»€ä¹ˆï¼Ÿ

éœ€è¦æ„å»ºä¸¤ä¸ªè¡¨ï¼ŒBear keepers å’Œ Giraffe keepersï¼Œç„¶åå–äº¤é›† 

**å…ˆæ„å»ºBear keepersè¡¨**

![image-20240716175623140](http://198.46.215.27:49153/i/669643ca5ca5f.png)



![image-20240716175718377](http://198.46.215.27:49153/i/66964401c8d10.png)

**å†æ„å»ºGiraffe keepersè¡¨**

![æˆªå±2024-07-16 17.59.04](http://198.46.215.27:49153/i/6696447286c80.png)

**æœ€åè”æ¥**

![æˆªå±2024-07-16 17.59.46](http://198.46.215.27:49153/i/6696449ba2f3d.png)



## SQLå¿…è¦ç»ƒä¹  + è®ºæ–‡é˜…è¯»

1ã€ [å®ŒæˆSQLçš„ç»ƒä¹ ]([1. SQL â€” A Practical Introduction to Databases (runestone.academy)](https://runestone.academy/ns/books/published/practical_db/PART1_SQL/index.html))

2ã€ [å®Œæˆå…³ç³»æ¨¡å‹ï¼ˆ3.1èŠ‚ï¼‰çš„ç»ƒä¹ ]([3. RELATIONAL DATABASE THEORY â€” A Practical Introduction to Databases (runestone.academy)](https://runestone.academy/ns/books/published/practical_db/PART3_RELATIONAL_DATABASE_THEORY/index.html))

3ã€ é˜…è¯»å‚è€ƒä¹¦ä¸Šçš„Michael Stonebrakerå’ŒJoseph Hellersteinçš„æ–‡ç« ã€ŠWhat Goes Around Comes Aroundã€‹ä¸­çš„ç¬¬1è‡³4èŠ‚

4ã€ï¼ˆå¯é€‰ï¼‰å…³ç³»æ¨¡å‹çš„å¼€å±±é¼»ç¥–è®ºæ–‡ï¼› E.F. Codd. A relational model of data for large shared data banks. Communications of the ACM, 1970.[[PDF](http://portal.acm.org/ft_gateway.cfm?id=362685&type=pdf&coll=GUIDE&dl=GUIDE&CFID=1781172&CFTOKEN=98614393)].

å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

- å“ªäº›ç±»å‹çš„ç¨‹åºåœ¨SQLä¸­ç¼–å†™èµ·æ¥å®¹æ˜“ï¼Ÿå“ªäº›ç±»å‹çš„ç¨‹åºè¾ƒéš¾ï¼Ÿ
- æ‚¨è§‰å¾—å£°æ˜å¼ç¼–ç¨‹æ¯”å‘½ä»¤å¼ç¼–ç¨‹æ›´å®¹æ˜“è¿˜æ˜¯æ›´éš¾ï¼Ÿ
- ä»€ä¹ˆæ˜¯æ•°æ®ç‹¬ç«‹æ€§çš„æ¦‚å¿µï¼Ÿä¸ºä»€ä¹ˆå®ƒå¾ˆé‡è¦ï¼Ÿ
- å…³ç³»æ¨¡å‹èƒŒåçš„å…³é”®æ€æƒ³æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬ä¸ºä½•ä¼˜äºä¹‹å‰çš„æ¨¡å‹ï¼Ÿå…³ç³»æ¨¡å‹åœ¨å“ªäº›æ–¹é¢å…·æœ‰é™åˆ¶æ€§ï¼Ÿ
- â€œåˆ†å±‚â€æ¨¡å‹ï¼ˆå¦‚IMSç³»ç»Ÿï¼‰ä¸Coddæå‡ºçš„å…³ç³»æ¨¡å‹ä¹‹é—´æœ€é‡è¦çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
