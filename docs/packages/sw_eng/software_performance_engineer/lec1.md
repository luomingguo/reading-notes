# Lec 1 ä»‹ç»&çŸ©é˜µä¹˜æ³•

è¿™èŠ‚è¯¾ä¸»è¦ä»‹ç»æ€§èƒ½å·¥ç¨‹ç›¸å…³çš„èƒŒæ™¯ï¼Œä»¥åŠå¿«é€Ÿå…¥é—¨ï¼š ä»ä¸€ä¸ªç®€å•çš„çŸ©é˜µä¹˜æ³•å‡ºå‘ï¼Œå¯å‘å¼åœ°é€šè¿‡å„ç§æ€§èƒ½ä¼˜åŒ–æ–¹å‘ï¼Œæœ€ç»ˆè·å–æ¯ç§æ–¹æ³•çš„ä¼˜åŒ–ç»“æœã€‚

## æ€»è§ˆ

- ä»‹ç»
- å¿«é€Ÿå…¥é—¨ï¼šçŸ©é˜µä¹˜æ³•

## ä»‹ç»

### æ€§èƒ½çš„é‡è¦æ€§

æ€§èƒ½å¾ˆé‡è¦å—ï¼Ÿ ä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¼šä¸ºäº†å®ç°æŸäº›æ€§è´¨è€Œç‰ºç‰²æ€§èƒ½ï¼Œæ¯”å¦‚

- å¯è°ƒè¯•æ€§
- é²æ£’æ€§
- å®‰å…¨æ€§
- æ¨¡å—åŒ–
- å¯ç»´æŠ¤æ€§

ç­‰ç­‰ã€‚ å¦‚æœæˆ‘ä»¬ç»™ä½ 2ç¾å…ƒï¼Œå’Œä»·å€¼ä¸¤ç¾å…ƒçš„æ°´ä½ ä¼šé€‰å“ªä¸ªï¼Ÿ ä¸€èˆ¬æ¥è¯´ä½ ä¼šé€‰æ‹©2ç¾å…ƒï¼Œæ€§èƒ½å°±å¦‚åŒè¿™2ç¾å…ƒï¼Œå°±æ˜¯ä½ çš„èµ„æœ¬ï¼Œä½ å¯ä»¥ç”¨è¿™ä¸¤ç¾å…ƒæ¥è´­ä¹°æŸäº›æ€§è´¨ã€‚

### æ‘©å°”å®šå¾‹å·²ç»å¤±æ•ˆäº†

![image-20241002040836267](http://14.103.135.111:49153/i/684943aa22d61.png)

1965å¹´æ‘©å°”æå‡ºï¼Œâ€œæ¯éš”å¤§çº¦ 18~24 ä¸ªæœˆï¼Œé›†æˆç”µè·¯ä¸Šçš„æ™¶ä½“ç®¡æ•°é‡å°†ç¿»ä¸€å€ï¼Œæ€§èƒ½æé«˜ï¼Œæˆæœ¬ä¸‹é™ã€‚â€ï¼Œåœ¨2004å¹´ä»¥å‰ï¼Œæ‘©å°”å®šå¾‹åŸºæœ¬æœ‰æ•ˆã€‚

ä½†ä»2004å¹´å¼€å§‹ï¼Œä¸»é¢‘ç“¶é¢ˆå‡ºç°ï¼Œåœ¨3-4GHzéš¾ä»¥æå‡ï¼Œè™½ç„¶åœ¨æ™¶ä½“ç®¡æ•°é‡ä¸Šç»§ç»­æœ‰æ•ˆï¼Œä½†æ€§èƒ½ä¸å†çº¿æ€§å¢é•¿ã€‚ä¾›åº”å•†çš„è§£å†³æ–¹æ¡ˆğŸ’¡ï¼šè½¬å‘å¤šæ ¸æ¶æ„ã€‚

è™½ç„¶æ‘©å°”å®šå¾‹æŒç»­æå‡è®¡ç®—æœºæ€§èƒ½ã€‚ ä½†ç°åœ¨ï¼Œè¿™ç§æ€§èƒ½å¯ä»¥é€šè¿‡é…å¤‡å¤æ‚ç¼“å­˜ã€çŸ¢é‡å•å…ƒã€ GPUã€FPGA ç­‰çš„å¤šæ ¸å¤„ç†å™¨å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ€§èƒ½å·²ç»ä¸å†å…è´¹çš„äº†ã€‚è½¯ä»¶å¿…é¡»é€‚åº”å’Œé«˜æ•ˆåˆ©ç”¨ç¡¬ä»¶èµ„æºã€‚

ä»ç°åœ¨çœ‹ï¼Œæˆ‘ä»¬è¯´ï¼Œæ‘©å°”å®šå¾‹å·²ç»ç»“æŸäº†ã€‚è‹±ç‰¹å°”åœ¨ 2014 å¹´å®ç°äº† 14 çº³ç±³å·¥è‰ºï¼Œæ ¹æ®æ‘©å°”å®šå¾‹ï¼Œè‹±ç‰¹å°”åº”è¯¥åœ¨ï¼šF

- 2016 å¹´å®ç° 10 çº³ç±³å·¥è‰º
- 2018 å¹´å®ç° 7 çº³ç±³å·¥è‰º
- 2020 å¹´å®ç° 5 çº³ç±³å·¥è‰º
- ä½†è‹±ç‰¹å°”ç›´åˆ° 2019 å¹´æ‰å‘å¸ƒ 10 çº³ç±³å·¥è‰ºï¼

åŠå¯¼ä½“æŠ€æœ¯å°†ä¸å†èƒ½ä¸ºåº”ç”¨ç¨‹åºæä¾›å…è´¹çš„æ€§èƒ½ã€‚è¿™åœºParty å·²ç»ç»“æŸäº†~

![image-20250611164917875](http://14.103.135.111:49153/i/68494313e86ee.png)

### ç°ä»£æ¡Œé¢CPU

![image-20241002042244847](http://14.103.135.111:49153/i/66fc5a1823a00.png)

ç°ä»£å¤šæ ¸æ¡Œé¢å¤„ç†å™¨åŒ…å«ï¼š

- å¹¶è¡Œå¤„ç†æ ¸å¿ƒ
- å‘é‡å•å…ƒ(vector)
- ç¼“å­˜
- é¢„å–å™¨(prefetchers)
- GPU
- è¶…çº¿ç¨‹
- åŠ¨æ€é¢‘ç‡è°ƒèŠ‚

è¿™äº›ç‰¹æ€§çš„åˆ©ç”¨å¯èƒ½é¢‡å…·æŒ‘æˆ˜æ€§ã€‚åœ¨æœ¬è¯¾ç¨‹ä¸­ï¼Œæ‚¨å°†å­¦ä¹ ç¼–å†™å¿«é€Ÿè¿è¡Œä»£ç çš„åŸåˆ™å’Œå®è·µã€‚





## ç¤ºä¾‹ï¼šçŸ©é˜µä¹˜æ³•

### è¿è¡Œè®¾å¤‡

![image-20250611170104573](http://14.103.135.111:49153/i/684945d5dfef7.png)

> FPUä¸Šé¢çš„æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

Solution: æ¯ä¸ªæ ¸å¿ƒæ¯ä¸ªå‘¨æœŸèƒ½æ‰§è¡Œ **8 ä¸ªåŒç²¾åº¦ FLOP**ï¼ŒåŒ…å«FMAï¼Œæ„å‘³ç€ä¸€ä¸ªæŒ‡ä»¤å¯ä»¥å®Œæˆä¸¤ä¸ªFLOPï¼ˆä¹˜åŠ å’Œï¼‰ï¼Œæ¯ä¸ªæ ¸å¿ƒæ¯å‘¨æœŸå¯ä»¥**å‘å°„ 2 æ¡ FMA æŒ‡ä»¤**ã€‚AVX æŒ‡ä»¤é›†ï¼ˆåé¢ä¼šå­¦ä¹ åˆ°ï¼‰

> è®¡ç®—å³°å€¼åŒç²¾åº¦æµ®ç‚¹æ€§èƒ½ï¼ˆGFLOPSï¼‰èƒ½è¾¾åˆ°å¤šå°‘ï¼Ÿ

Solution: $(2.9 * 10^9) * 2 * 9 $ =$ \approx 836 $GFLOPS



> [!NOTE]
>
> ç¬”è€…ç”¨çš„æ˜¯2020æ¬¾çš„Macbook M1ï¼ŒGFLOPS å¤§æ¦‚åªæœ‰ 160 GFLOPS

![image-20241002041457059](http://14.103.135.111:49153/i/66fc58465df64.png)

### ç‰ˆæœ¬0ï¼šåˆå§‹ä»£ç 

Pythonå®ç°ç¬¬ä¸€ä¸ªç‰ˆæœ¬

```python3
import random
import time

# n = 4096
n = 1024

# åˆå§‹åŒ–çŸ©é˜µ Aã€Bã€C
A = [[random.random() for _ in range(n)] for _ in range(n)]
B = [[random.random() for _ in range(n)] for _ in range(n)]
C = [[0 for _ in range(n)] for _ in range(n)]

# è®°å½•å¼€å§‹æ—¶é—´
start = time.time()

# çŸ©é˜µä¹˜æ³•ï¼šC = A Ã— B
for i in range(n):
    for j in range(n):
        for k in range(n):
            C[i][j] += A[i][k] * B[k][j]

# è®°å½•ç»“æŸæ—¶é—´
end = time.time()

# è¾“å‡ºè¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
print('ç‰ˆæœ¬1â€”â€”pythonåµŒå¥—è€—æ—¶: %.6f' % (end - start))  # ç»“æœ137ç§’
```

åˆ†æè®¡ç®—çš„èƒŒåæ•°æ®ï¼š

- $2n^3 = 2(2^{10})^3 = 2^{31}$æ¬¡æµ®ç‚¹æ•°æ“ä½œ
- MFLOPSï¼š $2^{31} / 137 \approx 15.6 \text{  MFLOPS}$

- å³°å€¼ 


### ç‰ˆæœ¬1ï¼šé‡‡ç”¨Cè¯­è¨€

```c
/*
 * version1: ç”¨Cè¯­è¨€å®ç°
 */

#include <stdlib.h>
#include <stdio.h>
#include <sys/time.h>

#define n 1024

double A[n][n];
double B[n][n];
double C[n][n];

float tdiff(struct timeval *start, struct timeval *end) {
    return (end->tv_sec - start->tv_sec) +
           1e-6 * (end->tv_usec - start->tv_usec);
}

int main(int argc, const char *argv[]) {
    // åˆå§‹åŒ–çŸ©é˜µ Aã€Bã€C
    for (int i = 0; i < n; ++i) {
        for (int j = 0; j < n; ++j) {
            A[i][j] = (double)rand() / (double)RAND_MAX;
            B[i][j] = (double)rand() / (double)RAND_MAX;
            C[i][j] = 0;
        }
    }

    struct timeval start, end;
    gettimeofday(&start, NULL);

    // çŸ©é˜µä¹˜æ³•
    for (int i = 0; i < n; ++i) {
        for (int j = 0; j < n; ++j) {
            for (int k = 0; k < n; ++k) {
                C[i][j] += A[i][k] * B[k][j];
            }
        }
    }

    gettimeofday(&end, NULL);
    printf("%0.6f\n", tdiff(&start, &end));
		// ç»“æœ4.2ç§’
    return 0;
}
```



| ç‰ˆæœ¬ | å®ç°   | è¿è¡Œæ—¶é—´ï¼ˆsï¼‰ | ç»å¯¹åŠ é€Ÿæ¯” | GFLOPS | å å³°å€¼æ¯”(%) |
| ---- | ------ | ------------- | ---------- | ------ | ----------- |
| 0    | Python | 137           | 1          | 0.015  | 0.001       |
| 1    | C      | 4.2           | 32         | 0.051  | 0.031       |

### ç‰ˆæœ¬2ï¼š æ›´æ”¹éå†é¡ºåº

è¿™ä¸ªä»£ç ä¸­ï¼Œè¡Œä¼˜å…ˆå­˜å‚¨

![image-20250611180630275](http://14.103.135.111:49153/i/6849552928bc4.png)

åˆå§‹æ–¹æ¡ˆ `i, j , k`é¡ºåºçš„è®¿é—®æ¨¡å¼ä¸º

![image-20250611180903250](http://14.103.135.111:49153/i/684955c243af6.png)

è°ƒæ•´é¡ºåºå

![image-20250611180930470](http://14.103.135.111:49153/i/684955dd74763.png)

```c
/*
 * version2: æ›´æ”¹éå†é¡ºåºï¼Œåˆ©ç”¨å±€éƒ¨æ€§
 */

#include <stdlib.h>
#include <stdio.h>
#include <sys/time.h>

#define n 1024

double A[n][n];
double B[n][n];
double C[n][n];

float tdiff(struct timeval *start, struct timeval *end) {
    return (end->tv_sec - start->tv_sec) +
           1e-6 * (end->tv_usec - start->tv_usec);
}

int main(int argc, const char *argv[]) {
    // åˆå§‹åŒ–çŸ©é˜µ Aã€Bã€C
    for (int i = 0; i < n; ++i) {
        for (int j = 0; j < n; ++j) {
            A[i][j] = (double)rand() / (double)RAND_MAX;
            B[i][j] = (double)rand() / (double)RAND_MAX;
            C[i][j] = 0;
        }
    }

    struct timeval start, end;
    gettimeofday(&start, NULL);

    // çŸ©é˜µä¹˜æ³•
    for (int i = 0; i < n; ++i) {
        for (int k = 0; k < n; ++k) {
            for (int j = 0; j < n; ++j) {
                C[i][j] += A[i][k] * B[k][j];
            }
        }
    }

    gettimeofday(&end, NULL);
    printf("%0.6f\n", tdiff(&start, &end));
		// æ‰§è¡Œæ—¶é—´ä¸º1.38s
    return 0;
}
```

åˆ°ç›®å‰ä¸ºæ­¢

| ç‰ˆæœ¬ | å®ç°         | è¿è¡Œæ—¶é—´ï¼ˆsï¼‰ | ç»å¯¹åŠ é€Ÿæ¯” | GFLOPS | å å³°å€¼æ¯”(%) |
| ---- | ------------ | ------------- | ---------- | ------ | ----------- |
| 0    | Python       | 137           | 1          | 0.015  | 0.001       |
| 1    | C            | 4.2           | 32         | 0.051  | 0.031       |
| 2    | æ›´æ”¹éå†é¡ºåº | 1.38          | 100        | 1.556  | 0.1         |

### ç‰ˆæœ¬3ï¼š ç¼–è¯‘ä¼˜åŒ–çº§åˆ«è°ƒæ•´

| ä¼˜åŒ–çº§åˆ« | å«ä¹‰     | æ—¶é—´ï¼ˆs) |
| -------- | -------- | -------- |
| -O0      | ä¸ä¼˜åŒ–   | 1.4      |
| -O1      | å¼€å¯ä¼˜åŒ– | 0.37     |
| -O2      | æ·±åº¦ä¼˜åŒ– | 0.19     |
| -O3      | æœ€é«˜ä¼˜åŒ– | 0.18     |

åˆ°ç›®å‰ä¸ºæ­¢

| ç‰ˆæœ¬ | å®ç°         | è¿è¡Œæ—¶é—´ï¼ˆsï¼‰ | ç»å¯¹åŠ é€Ÿæ¯” | GFLOPS | å å³°å€¼æ¯”(%) |
| ---- | ------------ | ------------- | ---------- | ------ | ----------- |
| 0    | Python       | 137           | 1          | 0.015  | 0.001       |
| 1    | C            | 4.2           | 32         | 0.051  | 0.031       |
| 2    | æ›´æ”¹éå†é¡ºåº | 1.38          | 100        | 1.556  | 0.1         |
| 3    | ç¼–è¯‘å™¨ä¼˜åŒ–   | 0.19          | 721        | 11.3   | 1.41        |
| 4    | å¹¶è¡Œéå†     |               |            |        |             |